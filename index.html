<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r68/three.js" type="text/javascript"></script>
<script src="js/TrackballControls.js"></script>
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>

    <script src="shaders/CopyShader.js"></script>
    <script src="shaders/DotScreenShader.js"></script>
    <script src="shaders/RGBShiftShader.js"></script>

    <script src="js/postprocessing/EffectComposer.js"></script>
    <script src="js/postprocessing/RenderPass.js"></script>
    <script src="js/postprocessing/MaskPass.js"></script>
    <script src="js/postprocessing/ShaderPass.js"></script>
    <script src="js/ThreeAudio.js"></script>

</head>


<script type="text/javascript">


var scene, camera, renderer, controls, composer, plane, audioTextures;

function setup() {
  // Empty Scene
  scene = new THREE.Scene();

  // Setup Camera
  camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.01, 1000 );
  camera.position.set(0, -1, 0.3);

  // Setup Renderer
  renderer = new THREE.WebGLRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	var container = $('body');
  container.append(renderer.domElement);

  //Trackball Controls
  controls = new THREE.TrackballControls( camera, renderer.domElement );
  controls.target.set(0, 0, 0);
  controls.noZoom = false;
  controls.noPan = false;





        // bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);//1.0, 9, 0.5, 512);
        // composer = new THREE.EffectComposer(renderer);
        // composer.setSize(window.innerWidth, window.innerHeight);
        // composer.addPass(renderScene);
        // composer.addPass(effectFXAA);
        // composer.addPass(bloomPass);
        // composer.addPass(copyShader);
        // //renderer.toneMapping = THREE.ReinhardToneMapping;
        // renderer.gammaInput = true;
        // renderer.gammaOutput = true;


}


function createCube() {
  var geometry = new THREE.BoxBufferGeometry( 2, 2, 2 );
  var material = new THREE.MeshBasicMaterial( { color: 0xff00ff } );
  return new THREE.Mesh( geometry, material );
}

function setupScene(vertexShader, fragmentShade) {

  // var audioSource = (new ThreeAudio.Source()).load('./mp3/maze.mp3');
  audioSource = (new ThreeAudio.Source()).mic().play();

  audioTextures = new ThreeAudio.Textures(renderer, audioSource); 

  // var geometry = new ThreeAudio.GridGeometry(audioTextures,  5, 5, 128, 128);

  var dim = 64;
  var geometry = new THREE.PlaneGeometry( 3.0, 3.0, dim, dim );

  shaderMaterial= new THREE.ShaderMaterial( {
    side: THREE.DoubleSide,
    transparent : true,
    blending: THREE.AdditiveBlending,
    depthWrite : false,
    // wireframe : true, 
    uniforms: {
      time: { value: 1.0 },
      resolution: { value: new THREE.Vector2() }

    },
    vertexShader: vertexShader,
    fragmentShader: fragmentShader

  } );

  var material = new ThreeAudio.Material(audioTextures, vertexShader, fragmentShader);

  plane = new THREE.Mesh( geometry, material );
  scene.add( plane );

}

var frame = 1;
var vertexShader, fragmentShader;


function render() {
    frame += 0.01;

    // plane.material.uniforms.time.value = frame;
    plane.rotation.y += 0.001;
    requestAnimationFrame( render );

    controls.update();
    audioTextures.update()
    // composer.render();
    renderer.render(scene,camera);


    
  }



function start(){
    setupScene(vertexShader, fragmentShader);


  composer = new THREE.EffectComposer( renderer );
  composer.addPass( new THREE.RenderPass( scene, camera ) );

  var effect = new THREE.ShaderPass( THREE.DotScreenShader );
  effect.uniforms[ 'scale' ].value = 10;
  composer.addPass( effect );

  var effect = new THREE.ShaderPass( THREE.RGBShiftShader );
  effect.uniforms[ 'amount' ].value = 0.005;
  effect.renderToScreen = true;
  composer.addPass( effect );
    render();
}


$( document ).ready(function() {
  setup();


  var shaderXhr_f = new XMLHttpRequest();
  shaderXhr_f.open("GET", "shaders/fragmentAudio.glsl", true);
  shaderXhr_f.onload = function() { fragmentShader = this.responseText;  if(fragmentShader&&vertexShader) start();};
  shaderXhr_f.send(null);

  var shaderXhr_v = new XMLHttpRequest();
  shaderXhr_v.open("GET", "shaders/vertexAudio.glsl", true);
  shaderXhr_v.onload = function() { vertexShader = this.responseText; if(fragmentShader&&vertexShader) start()  };
  shaderXhr_v.send(null);


});
</script>

</html>